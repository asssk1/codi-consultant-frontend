// âœ… App.jsx

// -----------------------------
// âœ… Import êµ¬ë¬¸
// -----------------------------
import React, { useState, useEffect } from "react";
import {
  getAuth,
  signInAnonymously,
  onAuthStateChanged,
  signOut,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
} from "firebase/auth";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  serverTimestamp,
  doc,
  setDoc,
} from "firebase/firestore";
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";

// -----------------------------
// âœ… Firebase ì„¤ì •
// -----------------------------
const firebaseConfig = {
  apiKey: "AIzaSyCD3oldgjO-TIWNCYgAPaLrciMzOmaSS34",
  authDomain: "ai-codi-consultant.firebaseapp.com",
  projectId: "ai-codi-consultant",
  storageBucket: "ai-codi-consultant.appspot.com",
  messagingSenderId: "335529211517",
  appId: "1:335529211517:web:1e3f407cfdcdbac08a6314",
  measurementId: "G-GS578RP9RY",
};

// âœ… Firebase ì´ˆê¸°í™”
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);
const auth = getAuth(app);

const appId = firebaseConfig.appId;
console.log("ğŸ”¥ Firebase App ID:", appId);

// -----------------------------
// âœ… Gemini API ì„¤ì •
// -----------------------------
const API_KEY = "AIzaSyAWv2SjUdrM1n-flUSaHa3wHCiS1zfuGX8";
const API_URL =
  "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";

// -----------------------------
// âœ… ìœ í‹¸ í•¨ìˆ˜
// -----------------------------
const fileToBase64 = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = (error) => reject(error);
  });
};

const getRandomPlaceholderImage = () => {
  const sizes = [
    "300x300",
    "350x350",
    "400x400",
    "450x450",
    "500x500",
    "300x400",
    "400x300",
    "350x450",
    "450x350",
  ];
  const randomSize = sizes[Math.floor(Math.random() * sizes.length)];
  return `https://placehold.co/${randomSize}/d1d5db/374151?text=Image`;
};

// -----------------------------
// âœ… ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// -----------------------------
export default function App() {
  // -----------------------------
  // âœ… ìƒíƒœ ê´€ë¦¬
  // -----------------------------
  const [user, setUser] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [outfitImage, setOutfitImage] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [recommendations, setRecommendations] = useState([]);
  const [savedOutfits, setSavedOutfits] = useState([]);
  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [name, setName] = useState("");
  const [dob, setDob] = useState("");
  const [authView, setAuthView] = useState("login"); // 'login' or 'signup'
  const [serviceView, setServiceView] = useState(null); // 'evaluation' or 'consultant'

  // -----------------------------
  // âœ… Firebase ì¸ì¦ & ë°ì´í„°
  // -----------------------------
  useEffect(() => {
    const signIn = async () => {
      try {
        await signInAnonymously(auth);
      } catch (error) {
        console.error("Firebase auth error:", error);
      }
    };
    signIn();

    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      setUser(currentUser);
      setIsAuthReady(true);
      if (currentUser) {
        const outfitsRef = collection(
          db,
          `artifacts/${appId}/users/${currentUser.uid}/saved_outfits`
        );
        const q = query(outfitsRef);
        onSnapshot(q, (snapshot) => {
          const outfits = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));
          outfits.sort(
            (a, b) =>
              (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)
          );
          setSavedOutfits(outfits);
        });
      }
    });

    return () => unsubscribe();
  }, []);

  // -----------------------------
  // âœ… íŒŒì¼ ì—…ë¡œë“œ
  // -----------------------------
  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setOutfitImage(file);
      setRecommendations([]);
      setErrorMessage("");
      setSuccessMessage("");
    }
  };

  // -----------------------------
  // âœ… ì½”ë”” ì¶”ì²œ
  // -----------------------------fetch
  const generateCodi = async () => {
    if (!outfitImage) {
      setErrorMessage("ì˜· ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.");
      return;
    }
    setErrorMessage("");
    setIsLoading(true);

    try {
      const base64Image = await fileToBase64(outfitImage);
      const prompt = `ì‚¬ìš©ìê°€ ì œê³µí•œ ì˜· ì‚¬ì§„ê³¼ ì–´ìš¸ë¦¬ëŠ” ë‚¨ì„± ì½”ë”” ì•„ì´ë””ì–´ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì¶”ì²œí•´ ì¤˜. 
      ì¶”ì²œ ì½”ë””ëŠ” 3ê°€ì§€ ì´ìƒìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ê° ì½”ë””ëŠ” 'ìƒì˜', 'í•˜ì˜', 'ì•„ìš°í„°', 'ì‹ ë°œ', 'ì•¡ì„¸ì„œë¦¬' ë“± ìµœì†Œ 3ê°œ ì´ìƒì˜ ì•„ì´í…œìœ¼ë¡œ êµ¬ì„±í•´ì¤˜. 
      ê° ì•„ì´í…œì˜ 'ìŠ¤íƒ€ì¼(style)'ê³¼ 'ìƒ‰ìƒ(color)'ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ë„ í¬í•¨í•´ì¤˜.
      JSON ì‘ë‹µ í˜•ì‹ì€ ë‹¤ìŒê³¼ ê°™ì•„:
      { "outfitRecommendations": [ { "title": "ì½”ë”” ì œëª©", "items": [ { "type": "ì•„ì´í…œ ì¢…ë¥˜", "style": "ìŠ¤íƒ€ì¼ ì„¤ëª…", "color": "ìƒ‰ìƒ ì„¤ëª…" }, ... ] }, ... ] }`;

      const payload = {
        contents: [
          {
            parts: [
              { text: prompt },
              {
                inlineData: {
                  mimeType: outfitImage.type,
                  data: base64Image,
                },
              },
            ],
          },
        ],
        generationConfig: {
          responseMimeType: "application/json",
          responseSchema: {
            type: "OBJECT",
            properties: {
              outfitRecommendations: {
                type: "ARRAY",
                items: {
                  type: "OBJECT",
                  properties: {
                    title: { type: "STRING" },
                    items: {
                      type: "ARRAY",
                      items: {
                        type: "OBJECT",
                        properties: {
                          type: { type: "STRING" },
                          style: { type: "STRING" },
                          color: { type: "STRING" },
                        },
                      },
                    },
                  },
                },
              },
            },
          },
        },
      };
      const response = await fetch("http://localhost:5000/api/gemini", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
      const result = await response.json();
      const textResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;

      if (textResponse) {
        try {
          const parsedData = JSON.parse(textResponse);
          setRecommendations(parsedData.outfitRecommendations);
        } catch (parseError) {
          console.error("Failed to parse JSON:", textResponse, parseError);
          setErrorMessage("ì£„ì†¡í•©ë‹ˆë‹¤. ì½”ë”” ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        }
      } else {
        setErrorMessage("ì½”ë”” ì¶”ì²œì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
      }
    } catch (error) {
      console.error("Error generating codi:", error);
      setErrorMessage("ì½”ë”” ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    } finally {
      setIsLoading(false);
    }
  };

  // -----------------------------
  // âœ… Firestore ì €ì¥
  // -----------------------------
  const saveOutfit = async (recommendation) => {
    if (!user || !user.uid) {
      setErrorMessage("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }
    if (!outfitImage) {
      setErrorMessage("ì˜· ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.");
      return;
    }
    try {
      const userId = user.uid;
      const outfitsRef = collection(
        db,
        `artifacts/${appId}/users/${userId}/saved_outfits`
      );
      await addDoc(outfitsRef, {
        outfitImageURL: URL.createObjectURL(outfitImage),
        recommendation,
        createdAt: serverTimestamp(),
      });
      setSuccessMessage("ì½”ë””ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      setTimeout(() => setSuccessMessage(""), 3000);
    } catch (error) {
      console.error("Error saving outfit:", error);
      setErrorMessage("ì½”ë”” ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    }
  };

  // -----------------------------
  // âœ… ë¡œê·¸ì¸/íšŒì›ê°€ì…/ë¡œê·¸ì•„ì›ƒ
  // -----------------------------
  const handleLogout = async () => {
    try {
      await signOut(auth);
      setSavedOutfits([]);
      setRecommendations([]);
      setOutfitImage(null);
      setSuccessMessage("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
      setTimeout(() => setSuccessMessage(""), 3000);
    } catch (error) {
      console.error("Logout error:", error);
      setErrorMessage("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    }
  };

  const handleLogin = async () => {
    setErrorMessage("");
    setSuccessMessage("");
    if (!email || !password) {
      setErrorMessage("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    setIsLoading(true);
    try {
      await signInWithEmailAndPassword(auth, email, password);
      setSuccessMessage("ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!");
    } catch (error) {
      console.error("Login error:", error);
      setErrorMessage("ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    } finally {
      setIsLoading(false);
    }
  };

  const handleSignup = async () => {
    setErrorMessage("");
    setSuccessMessage("");
    if (!name || !email || !password || !dob) {
      setErrorMessage("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (password.length < 6) {
      setErrorMessage("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }
    setIsLoading(true);
    try {
      const userCredential = await createUserWithEmailAndPassword(
        auth,
        email,
        password
      );
      const uid = userCredential.user.uid;

      const userDocRef = doc(db, `artifacts/${appId}/users/${uid}`);
      await setDoc(userDocRef, {
        name,
        dob,
        email,
        createdAt: serverTimestamp(),
      });

      setSuccessMessage("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      setAuthView("login");
    } catch (error) {
      console.error("Signup error:", error);
      if (error.code === "auth/email-already-in-use") {
        setErrorMessage("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
      } else if (error.code === "auth/invalid-email") {
        setErrorMessage("ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
      } else if (error.code === "auth/weak-password") {
        setErrorMessage("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      } else {
        setErrorMessage("íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    } finally {
      setIsLoading(false);
    }
  };

  // -----------------------------
  // âœ… UI êµ¬ì„± (AuthForm / Service / etc)
  // -----------------------------
  const AuthForm = () => (
    <div className="bg-white rounded-xl shadow-lg p-8 sm:p-12 text-center max-w-sm w-full">
      <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 mb-4">
        AI ì½”ë”” ì»¨ì„¤í„´íŠ¸
      </h1>
      <p className="text-gray-600 mb-8">
        {authView === "login"
          ? "ë¡œê·¸ì¸í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì„¸ìš”."
          : "íšŒì›ê°€ì…í•˜ê³  ë‚˜ë§Œì˜ ì½”ë””ë¶ì„ ë§Œë“œì„¸ìš”."}
      </p>

      {authView === "signup" && (
        <div className="space-y-4">
          <input
            type="text"
            placeholder="ì´ë¦„"
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          />
          <input
            type="date"
            placeholder="ìƒë…„ì›”ì¼"
            value={dob}
            onChange={(e) => setDob(e.target.value)}
            className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          />
        </div>
      )}

      <div className="space-y-4 mt-4">
        <input
          type="email"
          placeholder="ì´ë©”ì¼"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
        />
        <input
          type="password"
          placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
        />
      </div>

      <div className="flex flex-col sm:flex-row gap-4 mt-6">
        {authView === "login" ? (
          <button
            onClick={handleLogin}
            disabled={isLoading}
            className={`flex-1 px-6 py-3 rounded-lg shadow-md font-semibold transition ${
              isLoading
                ? "bg-gray-400 cursor-not-allowed"
                : "bg-gray-800 text-white hover:bg-gray-900"
            }`}
          >
            {isLoading ? "ë¡œê·¸ì¸ ì¤‘..." : "ë¡œê·¸ì¸"}
          </button>
        ) : (
          <button
            onClick={handleSignup}
            disabled={isLoading}
            className={`flex-1 px-6 py-3 rounded-lg shadow-md font-semibold transition ${
              isLoading
                ? "bg-gray-400 cursor-not-allowed"
                : "bg-blue-500 text-white hover:bg-blue-600"
            }`}
          >
            {isLoading ? "ê°€ì… ì¤‘..." : "íšŒì›ê°€ì…"}
          </button>
        )}
      </div>

      {errorMessage && <p className="text-red-500 mt-4 text-sm">{errorMessage}</p>}
      {successMessage && (
        <p className="text-green-500 mt-4 text-sm">{successMessage}</p>
      )}

      <p className="text-gray-500 text-sm mt-6">
        {authView === "login" ? "ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?" : "ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?"}
        <button
          onClick={() => setAuthView(authView === "login" ? "signup" : "login")}
          className="text-blue-500 font-medium ml-1 hover:underline focus:outline-none"
        >
          {authView === "login" ? "íšŒì›ê°€ì…" : "ë¡œê·¸ì¸"}
        </button>
      </p>
    </div>
  );

  // -----------------------------
  // âœ… ë Œë”ë§
  // -----------------------------
  if (!user) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 sm:p-8 font-sans">
        <AuthForm />
      </div>
    );
  }

  // TODO: ë‚˜ë¨¸ì§€ serviceView (consultant, evaluation)ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
  // ìœ„ìª½ ì½”ë“œì— ìˆë˜ render ë¶€ë¶„ ê·¸ëŒ€ë¡œ ë‘ë©´ ë¨.
}
